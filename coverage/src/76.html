<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\pierc\source\repos\RGBDS2CIL\RGBDS2CIL\Restructure.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;

namespace RGBDS2CIL
{
	public static class Restructure
	{
		internal static void RestructureMacros(List&lt;IAsmLine&gt; parsedLines)
		{
			var macrosToUpdate = new List&lt;MacroLine&gt;();
			var linesToRemove = new List&lt;IAsmLine&gt;();

			foreach (var macroLine in parsedLines.OfType&lt;MacroLine&gt;().Where(x =&gt; x.Lines.Count == 0).ToArray())
			{
				var macroContents = parsedLines
					.SkipWhile(x =&gt; x.Line &lt; macroLine.Line)
					//.SkipWhile(x =&gt; x is not MacroLine)
					.TakeWhile(x =&gt; x is not EndMacroLine)
					.ToList();

				var endline = parsedLines[parsedLines.IndexOf(macroContents.Last()) + 1];

				var macro = macroContents.OfType&lt;MacroLine&gt;().First();
				macro.Lines = macroContents.Skip(1).ToList();
				macro.Lines.Add(endline);

				linesToRemove.AddRange(macro.Lines);

				macrosToUpdate.Add(macro);
			}

			parsedLines.RemoveAll(x =&gt;
				linesToRemove.Select(x =&gt; x.Line).Contains(x.Line) &amp;&amp;
				linesToRemove.Select(x =&gt; x.FileName).Contains(x.FileName));

			foreach (var macroLine in macrosToUpdate)
			{
				var thisMacroLineIndex = parsedLines.FindIndex(x =&gt; x.Line == macroLine.Line &amp;&amp; x.FileName == macroLine.FileName);
				Program.RestructureLines(macroLine.Lines);
				parsedLines[thisMacroLineIndex] = macroLine;
			}
		}

		internal static void RestructureIfs(List&lt;IAsmLine&gt; parsedLines)
		{
			var ifsToUpdate = new List&lt;IfLine&gt;();
			var linesToRemove = new List&lt;IAsmLine&gt;();

			foreach (var ifLine in parsedLines.OfType&lt;IfLine&gt;().Where(x =&gt; x.Lines.Count == 0 &amp;&amp; !x.IsElseIf).ToArray())
			{
				var macroContents = parsedLines
					.SkipWhile(x =&gt; x.Line &lt; ifLine.Line)
					//.SkipWhile(x =&gt; x is not MacroLine)
					.TakeWhile(x =&gt; x is not EndConditionLine)
					.ToList();

				var endline = parsedLines[parsedLines.IndexOf(macroContents.Last()) + 1];

				var macro = macroContents.OfType&lt;IfLine&gt;().First();
				macro.Lines = macroContents.Skip(1).ToList();
				macro.Lines.Add(endline);

				linesToRemove.AddRange(macro.Lines);

				ifsToUpdate.Add(macro);
			}

			parsedLines.RemoveAll(x =&gt;
				linesToRemove.Select(x =&gt; x.Line).Contains(x.Line) &amp;&amp;
				linesToRemove.Select(x =&gt; x.FileName).Contains(x.FileName));

			foreach (var ifToUpdate in ifsToUpdate)
			{
				var thisMacroLineIndex = parsedLines.FindIndex(x =&gt; x.Line == ifToUpdate.Line &amp;&amp; x.FileName == ifToUpdate.FileName);
				Program.RestructureLines(ifToUpdate.Lines);
				parsedLines[thisMacroLineIndex] = ifToUpdate;
			}
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[9,3,9,4,1],[10,4,10,47,1],[11,4,11,45,1],[13,4,13,11,1],[13,13,13,26,0],[13,27,13,29,1],[13,30,13,73,1],[13,73,13,91,0],[13,91,13,102,1],[13,30,13,102,1],[14,4,14,5,0],[15,5,16,22,0],[16,22,16,45,0],[16,45,18,22,0],[18,22,18,43,0],[18,43,19,16,0],[15,5,19,16,0],[21,5,21,78,0],[23,5,23,59,0],[24,5,24,50,0],[25,5,25,30,0],[27,5,27,41,0],[29,5,29,31,0],[30,4,30,5,0],[32,4,33,5,1],[33,5,33,31,1],[33,31,33,37,0],[33,37,34,31,1],[34,31,34,41,0],[34,41,34,63,1],[33,5,34,63,1],[34,63,34,65,1],[32,4,34,65,1],[36,4,36,11,1],[36,13,36,26,0],[36,27,36,29,1],[36,30,36,44,1],[37,4,37,5,0],[38,5,38,57,0],[38,57,38,117,0],[38,117,38,119,0],[38,5,38,119,0],[39,5,39,47,0],[40,5,40,49,0],[41,4,41,5,0],[42,3,42,4,1],[45,3,45,4,1],[46,4,46,41,1],[47,4,47,45,1],[49,4,49,11,1],[49,13,49,23,0],[49,24,49,26,1],[49,27,49,67,1],[49,67,49,100,0],[49,100,49,111,1],[49,27,49,111,1],[50,4,50,5,0],[51,5,52,22,0],[52,22,52,42,0],[52,42,54,22,0],[54,22,54,47,0],[54,47,55,16,0],[51,5,55,16,0],[57,5,57,78,0],[59,5,59,56,0],[60,5,60,50,0],[61,5,61,30,0],[63,5,63,41,0],[65,5,65,28,0],[66,4,66,5,0],[68,4,69,5,1],[69,5,69,31,1],[69,31,69,37,0],[69,37,70,31,1],[70,31,70,41,0],[70,41,70,63,1],[69,5,70,63,1],[70,63,70,65,1],[68,4,70,65,1],[72,4,72,11,1],[72,13,72,27,0],[72,28,72,30,1],[72,31,72,42,1],[73,4,73,5,0],[74,5,74,57,0],[74,57,74,119,0],[74,119,74,121,0],[74,5,74,121,0],[75,5,75,48,0],[76,5,76,50,0],[77,4,77,5,0],[78,3,78,4,1]]);
    </script>
  </body>
</html>